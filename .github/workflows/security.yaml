name: Security Checks

on:
  push:
    branches: ["**"]   # Run on all branches
  pull_request:
    branches: ["**"]   # Run on all PRs
  workflow_dispatch:    # Allow manual runs

jobs:
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks CLI
        run: |
          GITLEAKS_VERSION=8.24.3
          curl -sSL -o gitleaks.tar.gz https://github.com/zricethezav/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks.tar.gz

      - name: Run Gitleaks
        run: |
          # use github event range when available, fallback to full scan
          START_REF="${{ github.event.before }}"
          END_REF="${{ github.sha }}"
          if [ -z "$START_REF" ] || [ "$START_REF" = "0000000000000000000000000000000000000000" ]; then
            echo "No start ref available, running full repo scan"
            gitleaks detect --source . --redact --exit-code=2 --report-format=sarif --report-path=results.sarif
          else
            echo "Running incremental scan from $START_REF..$END_REF"
            gitleaks detect --redact -v --exit-code=2 --report-format=sarif --report-path=results.sarif --log-level=debug --log-opts=--no-merges --first-parent $START_REF..$END_REF || true
          fi

      - name: Upload Gitleaks Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-results.sarif
          path: results.sarif

  dependency-review:
    name: Dependency Review (Vulnerability Scan)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high   # fail build if high severity vuln detected
          comment-summary-in-pr: true
